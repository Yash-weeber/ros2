
#!/usr/bin/env python3
# import rclpy
# from rclpy.node import Node
# from rclpy.action import ActionClient
# from control_msgs.action import FollowJointTrajectory
# from trajectory_msgs.msg import JointTrajectoryPoint
# import pandas as pd
# import numpy as np
# import os
# from ikpy.chain import Chain
# from ament_index_python.packages import get_package_share_directory
#
#
# class UR5eCSVExecutor(Node):
#     def __init__(self):
#         super().__init__('ur5e_csv_executor')
#
#         self._action_client = ActionClient(self, FollowJointTrajectory,
#                                            '/joint_trajectory_controller/follow_joint_trajectory')
#
#         pkg_share = get_package_share_directory('ur_description')
#         urdf_file = os.path.join(pkg_share, 'urdf', 'ur_for_ik.urdf')
#
#         # Mask length 9: [Origin, Base, 6 Joints, Tool0]
#         self.arm_chain = Chain.from_urdf_file(
#             urdf_file,
#             active_links_mask=[False, False, True, True, True, True, True, True, False]
#         )
#
#         self.joint_names = ['shoulder_pan_joint', 'shoulder_lift_joint', 'elbow_joint',
#                             'wrist_1_joint', 'wrist_2_joint', 'wrist_3_joint']
#         self.home_pos = [0.16986918, -np.pi / 1.5, -1.1, -np.pi / 9, np.pi / 2, 1.64722557]
#         self.dt = 0.05
#
#         # Transformation: Robot Base at (0.0, -0.5, 0.45) in World
#         self.robot_offset_x = 0.0
#         self.robot_offset_y = -0.5
#         self.robot_offset_z = 0.45
#
#         self.csv_path = os.path.join(pkg_share, 'data', 'motion.csv')
#
#         self.get_logger().info("Waiting for Gazebo Action Server...")
#         self._action_client.wait_for_server()
#         self.timer = self.create_timer(3.0, self.execute_trajectory)
#
#     def execute_trajectory(self):
#         self.timer.cancel()
#         goal_msg = FollowJointTrajectory.Goal()
#         goal_msg.trajectory.joint_names = self.joint_names
#
#         # 1. Home Position
#         p_home = JointTrajectoryPoint()
#         p_home.positions = self.home_pos
#         p_home.time_from_start = rclpy.duration.Duration(seconds=4.0).to_msg()
#         goal_msg.trajectory.points.append(p_home)
#
#         # 2. Mop Tool Offset (from your xacro: length is 0.5m)
#         mop_length = 0.5
#
#         try:
#             df = pd.read_csv(self.csv_path)
#             self.get_logger().info(f"Solving {len(df)} points for the mop head...")
#
#             t_sum = 4.0
#             last_joints = [0.0, 0.0] + self.home_pos + [0.0]
#
#             for i, row in df.iterrows():
#                 # TRANSFORM: World -> Robot Base
#                 x_rob = float(row['x']) - self.robot_offset_x
#                 y_rob = float(row['y']) - self.robot_offset_y
#
#                 # IMPORTANT: If the mop head is at 0.49,
#                 # the flange (tool0) must be 0.5m HIGHER.
#                 z_rob_flange = (0.49 - self.robot_offset_z) + mop_length
#
#                 # Solve IK focusing on the vertical Z-axis of the tool
#                 # This keeps the mop vertical but lets the wrist find the best angle
#                 joint_sol = self.arm_chain.inverse_kinematics(
#                     target_position=[x_rob, y_rob, z_rob_flange],
#                     target_orientation=[0, 0, -1],  # Pointing down
#                     orientation_mode="Z",
#                     initial_position=last_joints
#                 )
#
#                 t_sum += self.dt
#                 p = JointTrajectoryPoint()
#                 p.positions = joint_sol[2:8].tolist()
#                 p.time_from_start = rclpy.duration.Duration(seconds=t_sum).to_msg()
#                 goal_msg.trajectory.points.append(p)
#                 last_joints = joint_sol
#
#                 if i % 1000 == 0:
#                     self.get_logger().info(f"Progress: {i}/{len(df)} points...")
#
#             self.get_logger().info("Trajectory ready. Sending to Gazebo...")
#             self._action_client.send_goal_async(goal_msg)
#
#         except Exception as e:
#             self.get_logger().error(f"IK failure: {e}")
#
#
# def main():
#     rclpy.init()
#     node = UR5eCSVExecutor()
#     rclpy.spin(node)
#     rclpy.shutdown()
#
#
# if __name__ == '__main__':
#     main()\
pkill -9 -f gazebo; pkill -9 -f gz; pkill -9 -f move_group; pkill -9 -f robot_state_publisher; pkill -9 -f rviz2
pkill -9 -f gazebo; pkill -9 -f gz; pkill -9 -f move_group; pkill -9 -f robot_state_publisher; pkill -9 -f rviz2; pkill -9 -f joint_state_publisher



yashrakesh@yashrakesh-AMD:~/ros2_ws$ pkill -9 -f gz
yashrakesh@yashrakesh-AMD:~/ros2_ws$ colcon build --packages-select ur_description --allow-overriding ur_description
Starting >>> ur_description
Finished <<< ur_description [0.04s]

Summary: 1 package finished [0.12s]
yashrakesh@yashrakesh-AMD:~/ros2_ws$ source install/setup.bash
yashrakesh@yashrakesh-AMD:~/ros2_ws$ export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
yashrakesh@yashrakesh-AMD:~/ros2_ws$ source install/setup.bash
yashrakesh@yashrakesh-AMD:~/ros2_ws$ ros2 launch ur_description cleaning_session.launch.py
